!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.OAuth=b(a)}):"undefined"!=typeof exports?module.exports=b(a):a.OAuth=b(a)}(this,function(a){"use strict";var b={AccessToken:{},Request:{},Storage:{}};return function(){if(-1!==navigator.appVersion.indexOf("MSIE 7.")||-1!==navigator.appVersion.indexOf("MSIE 8.")||-1!==navigator.appVersion.indexOf("MSIE 9."))throw new Error("The oauth.js library does not support IE7, IE8 or IE9 !");var a=XMLHttpRequest;XMLHttpRequest=function(){var b=this;this.oXMLHttpRequest=new a,this.oXMLHttpRequest.onabort=function(){b.onabort&&b.onabort()},this.oXMLHttpRequest.onerror=function(){b.onerror&&b.onerror()},this.oXMLHttpRequest.onload=function(){b.onload&&b.onload()},this.oXMLHttpRequest.onloadend=function(){b.onloadend&&b.onloadend()},this.oXMLHttpRequest.onloadstart=function(){b.onloadstart&&b.onloadstart()},this.oXMLHttpRequest.onprogress=function(){b.onprogress&&b.onprogress()},this.oXMLHttpRequest.onreadystatechange=function(){b.readyState=this.readyState,b.response=this.response,b.responseText=this.responseText,b.responseType=this.responseType,b.responseURL=this.responseURL,b.responseXML=this.responseXML,b.status=this.status,b.statusText=this.statusText,b.timeout=this.timeout,b.upload=this.upload,b.withCredentials=this.withCredentials,b.onreadystatechange&&b.onreadystatechange()},this.oXMLHttpRequest.ontimeout=function(){b.ontimeout&&b.ontimeout()},this.requestType=null,this.isResourceRequest=function(){return"__oauth_js_send_credentials__"!==this.requestType}},XMLHttpRequest.prototype={},XMLHttpRequest.DONE=4,XMLHttpRequest.HEADERS_RECEIVED=2,XMLHttpRequest.LOADING=3,XMLHttpRequest.OPENED=1,XMLHttpRequest.UNSENT=0,XMLHttpRequest.prototype.abort=function(){return this.oXMLHttpRequest.abort()},XMLHttpRequest.prototype.open=function(a,b,c,d,e){return this.oXMLHttpRequest.open(a,b,c,d,e)},XMLHttpRequest.prototype.overrideMimeType=function(a){return this.oXMLHttpRequest.overrideMimeType(a)},XMLHttpRequest.prototype.send=function(a){return this.oXMLHttpRequest.send(a)},XMLHttpRequest.prototype.getAllResponseHeaders=function(){return this.oXMLHttpRequest.getAllResponseHeaders()},XMLHttpRequest.prototype.getResponseHeader=function(a){return this.oXMLHttpRequest.getResponseHeader(a)},XMLHttpRequest.prototype.setRequestHeader=function(a,b){return this.oXMLHttpRequest.setRequestHeader(a,b)}}(),b.ABNFUtils={isValidGrantName:function(a){},isValidGrantType:function(a){},isValidNameChar:function(a){},isValidOneStarDIGIT:function(a){},isValidOneStarNQCHAR:function(a){},isValidOneStarNQSCHAR:function(a){},isValidOneStarVSCHAR:function(a){},isValidResponseChar:function(a){},isValidResponseName:function(a){},isValidResponseType:function(a){},isValidScope:function(a){},isValidScopeToken:function(a){return this.isValidOneStarNQCHAR(a)},isValidStarNQCHAR:function(a){},isValidStarUNICODECHARNOCRLF:function(a){},isValidTokenType:function(a){},isValidTypeName:function(a){},isValidURIReference:function(a){}},b.AuthStatus=function(a){var c=null,d=b.AuthStatus.DISCONNECTED;if(this.getAccessTokenResponse=function(){return c},this.isConnected=function(){return d===b.AuthStatus.CONNECTED},this.isDisconnected=function(){return d===b.AuthStatus.DISCONNECTED},this.toJSON=function(){return{status:d,accessTokenResponse:c?c.toJSON():null}},this.toString=function(){return JSON.stringify(this.toJSON())},"object"!=typeof a)throw new Error("This object must be initialized with a settings object !");if(a.status!==b.AuthStatus.CONNECTED&&a.status!==b.AuthStatus.DISCONNECTED)throw new Error("The settings object has no status property or an invalid status property !");if(!a.accessTokenResponse&&a.status!==b.AuthStatus.DISCONNECTED)throw new Error("An AuthStatus without an access token response must always be disconnected !");if(a.accessTokenResponse&&"object"!=typeof a.accessTokenResponse)throw new Error("The settings object has an invalid access token response object !");d=a.status,c=a.accessTokenResponse?a.accessTokenResponse:null},b.AuthStatus.CONNECTED="connected",b.AuthStatus.DISCONNECTED="disconnected",b.AuthStatus.createCorrupted=function(){var a=null,c=null;return a=new b.AccessToken.CriticalErrorResponse,a.setError("__oauth_js__storage_corrupted__"),c=new b.AuthStatus({status:b.AuthStatus.DISCONNECTED,accessTokenResponse:a})},b.AuthStatus.createFromString=function(a){var c=null;if("string"!=typeof a)c=b.AuthStatus.createCorrupted();else{var d=null;try{d=JSON.parse(a),c=b.AuthStatus.isJsonValid(d)?new b.AuthStatus({status:d.status,accessTokenResponse:b.AccessToken.AbstractResponse.createFromJson(d.accessTokenResponse)}):b.AuthStatus.createCorrupted()}catch(e){c=b.AuthStatus.createCorrupted()}}return c},b.AuthStatus.isJsonValid=function(a){var c=b.ObjectUtils.isObject(a);return c=c&&(a.status===b.AuthStatus.CONNECTED||a.status===b.AuthStatus.DISCONNECTED),null!==a.accessTokenResponse&&(c=c&&b.AccessToken.AbstractResponse.isJsonValid(a.accessTokenResponse)),c},b.FunctionUtils={bind:function(a,b){var c,d,e=function(){},f=Array.prototype.slice,g=Function.prototype.bind;if(g&&a.bind===g)return g.apply(a,f.call(arguments,1));if("function"!=typeof a)throw new TypeError;return c=f.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(f.call(arguments)));e.prototype=a.prototype;var g=new e;e.prototype=null;var h=a.apply(g,c.concat(f.call(arguments)));return Object(h)===h?h:g}}},b.LoginContext=function(){this._credentials=null,this._loginCb=null,this._loginFnCb=null,this._loginFnOpts=null,this._loginOpts=null,this._requestManager=null},b.LoginContext.prototype={getCredentials:function(){return this._credentials},getLoginCb:function(){return this._loginCb},getLoginFnCb:function(){return this._loginFnCb},sendCredentials:function(a,b,c){this._credentials=a,this._loginFnCb=b,this._loginFnOpts=c,this._requestManager._login(this,a,b)},_setLoginCb:function(a){this._loginCb=a},_setLoginOpts:function(a){this._loginOpts=a},_setRequestManager:function(a){this._requestManager=a}},b.ObjectUtils={extend:function(a,b){for(var c in b)a[c]=b[c];return a},isObject:function(a){var b=typeof a;return"function"===b||"object"===b&&!!a}},b.Promise=function(a){if(_fullfillmentListeners=[],_rejectionListeners=[],_state="pending","function"!=typeof a)throw new Error("You must provide an executor function !");a(function(a){if("pending"===_state){_state="fullfilled";for(var b=0;b<_fullfillmentListeners.length;++b)_fullfillmentListeners[b](a)}},function(a){if("pending"===_state){_state="rejected";for(var b=0;b<_rejectionListeners.length;++b)_rejectionListeners[b](a)}}),this.then=function(a,b){return _fullfillmentListeners.push(a),_rejectionListeners.push(b),this}},b.RequestContext=function(){this.originalXhr={xhr:null,args:{open:null,send:null,setRequestHeader:null}}},b.UrlUtils={addArgument:function(a,b,c){var d=a,e=b+"=",f=a.indexOf(e);if(-1!==a.indexOf("?"))if(-1!==f){var g=d.substring(0,f+e.length),h=d.substring(g.length),i=h.indexOf("&");-1===i?d=g+c:(h=h.substring(i),d=g+c+h)}else d=d+"&"+e+c;else d=d+"?"+e+c;return d},toQueryString:function(a){var b="";if("object"!=typeof a)throw new Error("The provided argument must be an object !");for(var c in a)b.length>0&&(b+="&"),b+=c,b+="=",b+=a[c];return b}},b.XhrUtils={copyAttributes:function(a,b){b.readyState=a.readyState,b.timeout=a.timeout,b.withCredentials=a.withCredentials,b.responseURL=a.responseURL,b.status=a.status,b.statusText=a.statusText,b.responseType=a.responseType,b.response=a.response,b.responseText=a.responseText,b.responseXML=a.responseXML},fromJSON:function(a){return{onabort:null,onerror:null,onload:null,onloadend:null,onloadstart:null,onprogress:null,onreadystatechange:null,ontimeout:null,readyState:a.readyState,response:a.response,responseText:a.responseText,responseType:"",responseURL:"",responseXML:a.responseXML,status:a.status,statusText:a.statusText,timeout:0,upload:{onabort:null,onerror:null,onload:null,onloadend:null,onloadstart:null,onprogress:null,ontimeout:null},withCredentials:!1}},toJSON:function(a){return{readyState:a.readyState,status:a.status,statusText:a.statusText,response:a.response,responseText:a.responseText,responseXML:a.responseXML}}},b.AccessToken.AbstractResponse=function(){var a=null,b=null;this.getJsonResponse=function(){return a},this.getXhr=function(){return b},this.setJsonResponse=function(b){a=b},this.setXhr=function(a){b=a}},b.AccessToken.AbstractResponse.createFromJson=function(a){if(!b.AccessToken.AbstractResponse.isJsonValid(a))throw new Error("The provided JSON object does not correspond to a valid Access Token Response !");var c=null;return"string"==typeof a.jsonResponse.error?(c=b.AccessToken.ErrorResponse.isCriticalErrorCode(a.jsonResponse.error)?new b.AccessToken.CriticalErrorResponse:new b.AccessToken.ErrorResponse,c.setError(a.jsonResponse.error)):c=new b.AccessToken.SuccessfulResponse,c.setJsonResponse(a.jsonResponse),c.setXhr(b.XhrUtils.fromJSON(a.xhr)),c},b.AccessToken.AbstractResponse.isJsonValid=function(a){var c=b.ObjectUtils.isObject(a);return c&&(c=b.ObjectUtils.isObject(a.jsonResponse)&&"string"==typeof a.jsonResponse.error?c&&b.AccessToken.ErrorResponse.isJsonResponseValid(a.jsonResponse):c&&b.AccessToken.SuccessfulResponse.isJsonResponseValid(a.jsonResponse),c=c&&b.AccessToken.AbstractResponse.isJsonXhrValid(a.xhr)),c},b.AccessToken.AbstractResponse.isJsonXhrValid=function(a){var c=b.ObjectUtils.isObject(a);return c=c&&"number"==typeof a.readyState,c=c&&"number"==typeof a.status,c=c&&"string"==typeof a.statusText,c=c&&"string"==typeof a.responseText},b.AccessToken.CriticalErrorResponse=function(){b.AccessToken.ErrorResponse.apply(this,arguments),this.setError("__oauth__js__uninitialized__")},b.AccessToken.CriticalErrorResponse.criticalErrorCodes=["__oauth_js__headers_bad_cache_control__","__oauth_js__headers_bad_media_type__","__oauth_js__headers_bad_pragma__","__oauth_js__entity_body_invalid_json__","__oauth_js__entity_body_not_json__","__oauth_js__status_lt_1xx__","__oauth_js__status_1xx__","__oauth_js__status_2xx__","__oauth_js__status_3xx__","__oauth_js__status_4xx__","__oauth_js__status_5xx__","__oauth_js__status_gt_5xx__","__oauth_js__storage_corrupted__","__oauth_js__uninitialized__"],b.AccessToken.ErrorResponse=function(){b.AccessToken.AbstractResponse.apply(this,arguments);var a="__oauth_js__uninitialized__";this.getError=function(){return a},this.isCriticalError=function(){return b.AccessToken.ErrorResponse.isCriticalErrorCode(a)},this.isExtensionError=function(){return!this.isStandardError()&&!this.isCriticalError()},this.isStandardError=function(){return-1!==b.AccessToken.ErrorResponse.standardErrorCodes.indexOf(a)},this.isError=function(){return!0},this.isSuccessful=function(){return!1},this.setError=function(b){a=b},this.toJSON=function(){return{error:a,jsonResponse:this.getJsonResponse(),xhr:this.getXhr()?b.XhrUtils.toJSON(this.getXhr()):null}}},b.AccessToken.ErrorResponse.standardErrorCodes=["invalid_request","invalid_client","invalid_grant","unauthorized_client","unsupported_grant_type","invalid_scope"],b.AccessToken.ErrorResponse.isCriticalErrorCode=function(a){return/^__oauth_js__[\w\d-_]+__$/.test(a)},b.AccessToken.ErrorResponse.isJsonResponseValid=function(a){var c=b.ObjectUtils.isObject(a);return c=c&&a.hasOwnProperty("error"),c=c&&"string"==typeof a.error,c=c&&/^[\x20-\x21\x23-\x5B\x5D-\x7E]+$/.test(a.error)},b.AccessToken.ResponseParser=function(){function a(a){var c=new b.AccessToken.CriticalErrorResponse;return c.setError("__oauth_js__entity_body_not_json__"),c.setXhr(a),c}function c(a,c){var d=new b.AccessToken.CriticalErrorResponse;return d.setError("__oauth_js__entity_body_invalid_json__"),d.setJsonResponse(c),d.setXhr(a),d}function d(a,c){var d=new b.AccessToken.ErrorResponse;return d.setJsonResponse(c),d.setXhr(a),d.setError(c.error),d}function e(a,c){var d=new b.AccessToken.SuccessfulResponse;return d.setJsonResponse(c),d.setXhr(a),d}this.parse=function(f){var g=null,h=null;try{g=JSON.parse(f.responseText),h=b.AccessToken.ErrorResponse.isJsonResponseValid(g)?d(f,g):b.AccessToken.SuccessfulResponse.isJsonResponseValid(g)?e(f,g):c(f,g)}catch(i){h=a(f)}return h}},b.AccessToken.SuccessfulResponse=function(){b.AccessToken.AbstractResponse.apply(this,arguments),this.isError=function(){return!1},this.isSuccessful=function(){return!0},this.toJSON=function(){return{jsonResponse:this.getJsonResponse(),xhr:b.XhrUtils.toJSON(this.getXhr())}}},b.AccessToken.SuccessfulResponse.isJsonResponseValid=function(a){var c=b.ObjectUtils.isObject(a);return c=c&&a.hasOwnProperty("access_token"),c=c&&a.hasOwnProperty("token_type"),c&&a.hasOwnProperty("expires_in"),c&&a.hasOwnProperty("refresh_token"),c&&a.hasOwnProperty("scope"),c},b.Storage.WebStorage=function(a){if(this._accessTokenResponseParser=new b.AccessToken.ResponseParser,this._storage=localStorage,this._storageKey="oauth.js","undefined"==typeof Storage)throw new Error("Your browser does not support HTML5 Web Storage !");b.ObjectUtils.isObject(a)&&(a.hasOwnProperty("storage")&&"object"==typeof a.storage?this._storage=a.storage:this._storage=localStorage,this._storageKey="string"==typeof a.storageKey?a.storageKey:"oauth.js")},b.Storage.WebStorage.prototype={clear:function(){this._storage.removeItem(this._storageKey+".authStatus")},getAuthStatusKey:function(){return this._storageKey+".authStatus"},getAuthStatus:function(){var a=null,c=null;return c=this._storage.getItem(this.getAuthStatusKey()),a=c?b.AuthStatus.createFromString(c):new b.AuthStatus({status:b.AuthStatus.DISCONNECTED}),this.persistAuthStatus(a),a},getRefreshToken:function(){var a=this.getAccessTokenResponse(),b=null!==a?a.refresh_token:null;return null===b||void 0===b?null:b},persistAuthStatus:function(a){this._storage.setItem(this.getAuthStatusKey(),a.toString())},persistAccessTokenResponse:function(a){if("object"!=typeof a)throw new Error("The provided XHMLHttpRequest object is invalid !");if(a.readyState!==XMLHttpRequest.DONE)throw new Error("The provided XHMLHttpRequest object must be in the DONE state before used for persistance !");var c=null,d=null;return c=this._accessTokenResponseParser.parse(a),d=new b.AuthStatus({status:c.isSuccessful()?b.AuthStatus.CONNECTED:b.AuthStatus.DISCONNECTED,accessTokenResponse:c}),this.persistAuthStatus(d),d}},b.Request.AbstractRequestManager=function(a){this._accessTokenResponseParser=new b.AccessToken.ResponseParser,this._loginFn=null,this._parseErrorFn=null,this._storageManager=null,this._tokenEndpoint=null,this._transformDataFn=a&&a.transformDataFn||function(a){return a},this.getLoginStatus=function(a,b){a(this._storageManager.getAuthStatus())},this.logout=function(a){this._storageManager.clear(),a()}},b.Request.AngularRequestManager=function(a){if(b.Request.AbstractRequestManager.apply(this,arguments),this._$http=null,this._$provide=a.$provide,!b.ObjectUtils.isObject(a))throw new Error("A configuration object is required !");if("function"!=typeof a.loginFn)throw new Error("No login function is provided !");if(this._loginFn=a.loginFn,"undefined"==typeof a.clientId)throw new Error("No client id is provided !");if(this._clientId=a.clientId,"string"!=typeof a.tokenEndpoint)throw new Error("No token endpoint is provided or its valued is invalid !");if(this._tokenEndpoint=a.tokenEndpoint,"function"!=typeof a.parseErrorFn)throw new Error("No parse error function is provided !");this._parseErrorFn=a.parseErrorFn,this._storageManager=a.storageManager||new b.Storage.WebStorage},b.Request.AngularRequestManager.prototype={sendCredentials:function(a,c,d){this._loginContext=new b.LoginContext,this._loginContext._setLoginCb(c),this._loginContext._setLoginOpts(d),this._loginContext._setRequestManager(this);var e=new XMLHttpRequest;switch(e.requestType="__oauth_js_send_credentials__",a.grant_type){case"password":if(e.open("POST",this._tokenEndpoint,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),navigator.userAgent.toLowerCase().indexOf("firefox")>-1){for(var f=b.UrlUtils.toQueryString(this._transformDataFn({grant_type:a.grant_type,client_id:this._clientId,username:a.username,password:a.password})),g=f.length,h=new Uint8Array(g),i=0;g>i;i++)h[i]=255&f.charCodeAt(i);e.send(h)}else e.send(b.UrlUtils.toQueryString(this._transformDataFn({grant_type:a.grant_type,client_id:this._clientId,username:a.username,password:a.password})));var j=this;e.onreadystatechange=function(){e.readyState===XMLHttpRequest.DONE&&j._onTokenEndpointPost(e)};break;default:throw new Error("Invalid credentials 'grant_type' provided !")}},_onTokenEndpointPost:function(a){var c=null,d=this._loginContext.getLoginCb(),e=this._loginContext.getLoginFnCb();if(c=this._storageManager.persistAccessTokenResponse(a),"function"==typeof e){var f=new b.Promise(function(a,b){e(c,a,b)});f.then(function(a){d(c)},function(a){d(c)})}else d(c)},login:function(a,c){this._loginContext=new b.LoginContext,this._loginContext._setLoginCb(a),this._loginContext._setLoginOpts(c),this._loginContext._setRequestManager(this),this._storageManager.getAuthStatus().isDisconnected()?this._loginFn(this._loginContext):a(this._storageManager.getAuthStatus())},_onRefreshAccessTokenPost:function(a,c){var d=this._storageManager.persistAccessTokenResponse(a);if(d.isConnected()){this._replayXhr=new XMLHttpRequest,this._replayXhr.open=this._backupedOpen,this._replayXhr.send=this._backupedSend,this._replayXhr.setRequestHeader=this._backupedSetRequestHeader,c.originalXhr.args.open[1]=b.UrlUtils.addArgument(c.originalXhr.args.open[1],"access_token",d.getAccessTokenResponse().getJsonResponse().access_token),this._replayXhr.open.apply(this._replayXhr,c.originalXhr.args.open),this._replayXhr.setRequestHeader.apply(this._replayXhr,c.originalXhr.args.setRequestHeader),this._replayXhr.send.apply(this._replayXhr,c.originalXhr.args.send);var e=this;this._replayXhr.onreadystatechange=function(){var a=c.originalXhr.xhr;e._replayXhr.readyState===XMLHttpRequest.DONE&&(b.XhrUtils.copyAttributes(e._replayXhr,a),e._replayXhr.status>=200&&e._replayXhr.status<300?(a.onreadystatechange&&a.onreadystatechange(),a.onload&&a.onload()):console.log("Error after replay..."))}}else this._loginFn(this._loginContext)},_refreshAccessToken:function(a){var c=this,d=this._storageManager.getAuthStatus(),e=new XMLHttpRequest;e.open=this._backupedOpen,e.send=this._backupedSend,e.setRequestHeader=this._backupedSetRequestHeader,e.open("POST",this._tokenEndpoint,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send(b.UrlUtils.toQueryString(this._transformDataFn({grant_type:"refresh_token",client_id:this._clientId,refresh_token:d.getAccessTokenResponse().getJsonResponse().refresh_token}))),e.onreadystatechange=function(){e.readyState===XMLHttpRequest.DONE&&c._onRefreshAccessTokenPost(e,a)}},start:function(){var a=this;this._$provide.decorator("$http",["$delegate",function(b){a._$http=b;var c=function(){var b=arguments;return b[0]=a._updateAngularHttpConfig(b[0]),a._$http.apply(a._$http,b)};return c.get=function(){var a=arguments[1];return a.method="GET",a.url=arguments[0],new c(a)},c.head=function(){var a=arguments[1];return a.method="HEAD",a.url=arguments[0],new c(a)},c.post=function(){var a=arguments[2];return a.data=arguments[1],a.method="POST",a.url=arguments[0],new c(a)},c.put=function(){var a=arguments[2];return a.data=arguments[1],a.method="POST",a.url=arguments[0],new c(a)},c["delete"]=function(){var a=arguments[1];return a.method="HEAD",a.url=arguments[0],new c(a)},c.jsonp=function(){var a=arguments[1];return a.method="JSONP",a.url=arguments[0],new c(a)},c.patch=function(){var a=arguments[2];return a.data=arguments[1],a.method="POST",a.url=arguments[0],new c(a)},c}]),this._backupedOpen=XMLHttpRequest.prototype.open,this._backupedSend=XMLHttpRequest.prototype.send,this._backupedSetRequestHeader=XMLHttpRequest.prototype.setRequestHeader,XMLHttpRequest.prototype.open=function(){var c=[].slice.call(arguments),d=new b.RequestContext;return d.originalXhr.xhr=this,d.originalXhr.args.open=c,this.requestContext=d,a._open(d,this,c)},XMLHttpRequest.prototype.setRequestHeader=function(b,c){var d=[].slice.call(arguments);return this.requestContext.originalXhr.args.setRequestHeader=d,a._setRequestHeader(this.requestContext,this,d)},XMLHttpRequest.prototype.send=function(b,c){var d=[].slice.call(arguments);return this.requestContext.originalXhr.args.send=d,a._send(this.requestContext,this,d)}},_setRequestHeader:function(a,b,c){this._backupedSetRequestHeader.apply(this._realXhr,c)},_send:function(a,b,c){this._backupedSend.apply(this._realXhr,c)},_open:function(a,c,d){this._realXhr=new XMLHttpRequest,this._realXhr.open=this._backupedOpen,this._realXhr.send=this._backupedSend,this._realXhr.setRequestHeader=this._backupedSetRequestHeader,this._backupedOpen.apply(this._realXhr,d);var e=this;this._realXhr.onreadystatechange=function(){if(this.readyState===XMLHttpRequest.DONE)if(b.XhrUtils.copyAttributes(this,c),c.isResourceRequest())if(this.status>=200&&this.status<300)c.onreadystatechange&&c.onreadystatechange(),c.onload&&c.onload();else{var d=e._parseErrorFn(c);"refresh"===d?e._refreshAccessToken(a):(c.onreadystatechange&&c.onreadystatechange(),c.onload&&c.onload())}else c.onreadystatechange()}},_updateAngularHttpConfig:function(a){var c=a;if(a.secured===!0){var d=this._storageManager.getAuthStatus();a.url=b.UrlUtils.addArgument(a.url,"access_token",d.getAccessTokenResponse().getJsonResponse().access_token)}return delete c.secured,c}},b.Request.BackboneRequestManager=function(a){if(b.Request.AbstractRequestManager.apply(this,arguments),this._backupedBackboneDotAjax=null,this._loginContext=null,this._clientType="backbone",this._clientId=null,"undefined"==typeof Backbone||null===Backbone)throw new Error("Backbone is not available !");if("function"!=typeof Backbone.ajax)throw new Error("No valid 'Backbone.ajax' method has been found !");if(this._backupedBackboneDotAjax=Backbone.ajax,!b.ObjectUtils.isObject(a))throw new Error("A configuration object is required !");if("function"!=typeof a.loginFn)throw new Error("No login function is provided !");if(this._loginFn=a.loginFn,"undefined"==typeof a.clientId)throw new Error("No client id is provided !");if(this._clientId=a.clientId,"string"!=typeof a.tokenEndpoint)throw new Error("No token endpoint is provided or its valued is invalid !");if(this._tokenEndpoint=a.tokenEndpoint,"function"!=typeof a.parseErrorFn)throw new Error("No parse error function is provided !");this._parseErrorFn=a.parseErrorFn,this._storageManager=a.storageManager||new b.Storage.WebStorage},b.Request.BackboneRequestManager.prototype={getStorageManager:function(){return this._storageManager},_onTokenEndpointPostError:function(a,b,c){var d=null,e=this._loginContext.getLoginCb(),f=this._loginContext.getLoginFnCb();if(d=this._storageManager.persistAccessTokenResponse(a),"function"==typeof f){var g=$.Deferred();f(d,function(){g.resolve()}),g.done(function(){e(d)})}else e(d)},_onTokenEndpointPostSuccess:function(a,b,c){var d=null,e=this._loginContext.getLoginCb(),f=this._loginContext.getLoginFnCb();if(d=this._storageManager.persistAccessTokenResponse(c),"function"==typeof f){var g=$.Deferred();f(d,function(){g.resolve()}),g.done(function(){e(d)})}else e(d)},_login:function(a){this._loginContext=a;var b=null,c=this._loginContext.getCredentials();if("password"===c.grant_type)b=$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:this._transformDataFn({grant_type:c.grant_type,client_id:this._clientId,username:c.username,password:c.password}),type:"POST",url:this._tokenEndpoint});else{if("gomoob_facebook_access_token"!==c.grant_type)throw new Error("Unknown 'grant_type' = '"+c.grant_type+"' !");b=$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:this._transformDataFn({grant_type:c.grant_type,client_id:this._clientId,facebook_access_token:c.facebook_access_token,facebook_app_scoped_user_id:c.facebook_app_scoped_user_id}),type:"POST",url:this._tokenEndpoint})}b.done($.proxy(this._onTokenEndpointPostSuccess,this)),b.fail($.proxy(this._onTokenEndpointPostError,this))},login:function(a,c){this._loginContext=new b.LoginContext,this._loginContext._setLoginCb(a),this._loginContext._setLoginOpts(c),this._loginContext._setRequestManager(this),this._storageManager.getAuthStatus().isDisconnected()?this._loginFn(this._loginContext):a(this._storageManager.getAuthStatus())},start:function(){var a=this;Backbone.ajax=function(){return a._overwrittenBackboneDotAjax.apply(a,arguments)}},_cloneAjaxArguments:function(a){var b={};return"string"==typeof a[0]?(b[0]=a[0],2===b.length&&(b[1]=this._cloneAjaxSettings(a[1]))):b[0]=this._cloneAjaxSettings(a[0]),b},_cloneAjaxSettings:function(a){for(var b=["accepts","async","beforeSend","cache","complete","contents","contentType","context","converters","crossDomain","data","dataFilter","dataType","error","global","headers","isModified","isLocal","jsonp","jsonpCallback","mimeType","password","processData","scriptCharset","statusCode","success","timeout","traditional","type","url","username","xhr","xhrFields"],c={},d=0;d<b.length;++d)"undefined"!=typeof a[b[d]]&&(c[b[d]]=a[b[d]]);return c},_createOAuthPromise:function(a){var b=$.Deferred();return b.getResponseHeader=function(b){return a.getResponseHeader(b)},b.getAllResponseHeaders=function(){return a.getAllResponseHeaders()},b.setRequestHeader=function(b,c){return a.setRequestHeader(b,c),this},b.overrideMimeType=function(b){return a.overrideMimeType(b),this},b.statusCode=function(b){return a.statusCode(b),this},b.abort=function(b){return a.abort(b),this},b.success=b.done,b.error=b.fail,b.readyState=a.readyState,b.status=a.status,b.statusText=a.statusText,b},_jQueryAjaxPromiseDone:function(a,b,c,d,e){b.resolve(c,d,e)},_jQueryAjaxPromiseFail:function(a,b,c,d,e){var f=this._parseErrorFn(c);if(void 0!==f)switch(f){case"refresh":this._refreshAccessToken(a,b);break;case"reniew":this._reniewAccessToken(a,b);break;default:throw new Error("Action '"+f+"' is invalid !")}else b.reject(c,d,e)},_updateAjaxArgumentsWithAccessToken:function(a){var c=this._storageManager.getAuthStatus();if(c.isConnected()){var d=c.getAccessTokenResponse().getJsonResponse().access_token;"string"==typeof a[0]?a[0]=b.UrlUtils.addArgument(a[0],"access_token",d):a[0].secured&&(a[0].url=b.UrlUtils.addArgument(a[0].url,"access_token",d))}},_overwrittenBackboneDotAjax:function(){var a=this._cloneAjaxArguments(arguments);this._updateAjaxArgumentsWithAccessToken(arguments);var b=Backbone.$.ajax.apply(Backbone.$,arguments),c=this._createOAuthPromise(b);return b.fail($.proxy(this._jQueryAjaxPromiseFail,this,a,c)),b.done($.proxy(this._jQueryAjaxPromiseDone,this,a,c)),c},_onOriginalRequestReplayedDone:function(a,b,c,d){a.resolve(b,c,d)},_onOriginalRequestReplayedFail:function(a,b,c,d){a.reject(b,c,d)},_onRefreshAccessTokenSuccess:function(a,b,c,d,e){this._storageManager.persistAccessTokenResponse(e);var f=this._cloneAjaxArguments(a);f[0].secured=!0,this._updateAjaxArgumentsWithAccessToken(f);var g=$.ajax(f[0]);g.done($.proxy(this._onOriginalRequestReplayedDone,this,b)),g.fail($.proxy(this._onOriginalRequestReplayedFail,this,b))},_onReniewAccessTokenSuccess:function(a,b,c,d,e){this._storageManager.persistAccessTokenResponse(e);var f=$.ajax(a);f.done($.proxy(this._onOriginalRequestReplayedDone,this,b)),f.fail($.proxy(this._onOriginalRequestReplayedFail,this,b))},_refreshAccessToken:function(a,b){var c=this._storageManager.getAuthStatus();if(c.isConnected()&&null!==c.getAccessTokenResponse().getJsonResponse().refresh_token){var d=$.ajax({url:this._tokenEndpoint,data:this._transformDataFn({grant_type:"refresh_token",refresh_token:c.getAccessTokenResponse().getJsonResponse().refresh_token,client_id:this._clientId}),dataType:"json",type:"POST"});d.fail($.proxy(this._reniewAccessToken,this,b)),d.done($.proxy(this._onRefreshAccessTokenSuccess,this,a,b))}else this._reniewAccessToken(a,b)},_reniewAccessToken:function(a,b){if(null===this._loginContext)throw new Error("No login context found, did you miss to wrap your calls in 'OAuth.login' ?");console.log("_reniewAccessToken");var c=$.Deferred();this._loginContext._setRequestManager(this),this._loginFn(this._loginContext),c.done($.proxy(this._onCredentialsPromiseDone,this,a,b)),c.fail($.proxy(function(){console.log("_reniewAccessToken Error !")},this))},_onCredentialsPromiseDone:function(a,b,c){switch(c.grant_type){case"password":var d=$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:this._transformDataFn({grant_type:"password",username:c.username,password:c.password,client_id:this._clientId}),type:"POST",url:this._tokenEndpoint});d.done($.proxy(this._onReniewAccessTokenSuccess,this,a,b));break;case"client_credentials":$.ajax({contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:this._transformDataFn({grant_type:"client_credentials",client_id:this._clientId}),type:"POST",url:this._tokenEndpoint})}}},b.init=function(a,c){switch(a){case"angular":b._requestManager=new b.Request.AngularRequestManager(c);break;case"backbone":b._requestManager=new b.Request.BackboneRequestManager(c);break;default:throw new Error("Unknown or unsupported framework '"+a+"' !")}b._requestManager.start()},b.getLoginStatus=function(a,c){return b._requestManager.getLoginStatus(a,c)},b.login=function(a,c){return b._requestManager.login(a,c)},b.logout=function(a){return b._requestManager.logout(a)},b.sendCredentials=function(a,c,d){return b._requestManager.sendCredentials(a,c,d)},b});
//# sourceMappingURL=oauth.min.js.map